<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modeling</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    {% load static %}
    <link href="{% static 'css/common.css' %}" rel="stylesheet">
    <link href="{% static 'css/modelling.css' %}" rel="stylesheet">
    <style>
    /* Màu chủ đạo */
    :root {
        --primary-light: #f7dd67;
        --primary: #eec73b;
        --primary-dark: #d89810;
    }

    /* Style cho prediction result */
    .prediction-result {
        background: var(--primary-light);
        box-shadow: 0 4px 15px rgba(216, 152, 16, 0.15);
    }

    /* Style cho form controls khi focus */
    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(238, 199, 59, 0.25);
    }

    /* Style cho range slider */
    .form-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary);
        border: 2px solid #fff;
        box-shadow: 0 0 2px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .form-range::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary);
        border: 2px solid #fff;
        box-shadow: 0 0 2px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    /* Hover effect */
    .form-range::-webkit-slider-thumb:hover {
        background: var(--primary-dark);
        transform: scale(1.1);
    }

    .form-range::-moz-range-thumb:hover {
        background: var(--primary-dark);
        transform: scale(1.1);
    }

    /* Track style */
    .form-range::-webkit-slider-runnable-track {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
    }

    .form-range::-moz-range-track {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
    }

    /* Focus styles */
    .form-range:focus::-webkit-slider-thumb {
        box-shadow: 0 0 0 3px rgba(238, 199, 59, 0.25);
    }

    .form-range:focus::-moz-range-thumb {
        box-shadow: 0 0 0 3px rgba(238, 199, 59, 0.25);
    }

    /* Style cho hover effects */
    .form-control:hover, .form-select:hover {
        border-color: var(--primary-dark);
    }

    /* Style cho section container hover */
    .section-container:hover {
        box-shadow: rgba(216, 152, 16, 0.15) 0px 8px 24px;
    }

    /* Style cho button */
    .btn-primary {
        background-color: var(--primary);
        border-color: var(--primary);
        color: #000;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
        color: #000;
    }

    /* Style cho active nav link */
    .nav-link.active {
        color: var(--primary-dark) !important;
    }

    .nav-link:hover {
        color: var(--primary) !important;
    }

    .nav-link.active::after {
        background-color: var(--primary-dark);
    }

    /* Style cho range value input focus */
    .range-value-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(238, 199, 59, 0.25);
    }

    .summary-label {
        color: #6c757d;  /* Bootstrap's text-muted color */
        font-weight: normal;
    }

    /* Thêm style cho phần Input Summary */
    .input-summary {
        border-top: 1px solid #dee2e6;
        margin-top: 1.5rem;
        padding: 1.5rem;
        padding-top: 0;
    }

    .input-summary .row {
        --bs-gutter-x: 2rem;  /* Tăng khoảng cách giữa các cột */
    }

    /* Style cho tiêu đề và nút toggle */
    .summary-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 0;
        border-bottom: 1px solid #dee2e6;
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
    }

    .summary-header:hover {
        color: var(--primary-dark);
    }

    .summary-header i {
        transition: transform 0.3s ease;
        font-size: 1.5rem;  /* Tăng kích thước icon */
        color: black;  /* Màu vàng đậm */
        font-weight: bold;
    }

    /* Style cho header khi hover */
    .summary-header:hover i {
        color: var(--primary);  /* Màu vàng nhạt hơn khi hover */
    }

    /* Animation xoay icon */
    .summary-header[aria-expanded="true"] i {
        transform: rotate(180deg);
    }

    /* Style cho phần kết quả dự đoán */
    .prediction-result {
        text-align: center;
        padding: 2rem;
        background: lvar(--primary);
        border-radius: 15px;
        color: #2C1810;  /* Màu chữ tối */
        box-shadow: 0 4px 15px rgba(216, 152, 16, 0.2);
    }

    .prediction-result h3 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        font-weight: 600;
    }

    .prediction-result .age-value {
        font-weight: 700;
        background: rgba(255, 255, 255, 0.5);  /* Background trong suốt hơn */
        padding: 0.5rem 1.5rem;
        border-radius: 50px;
        color: #2C1810;  /* Màu chữ tối */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .prediction-message {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
        font-size: 1.1rem;
        color: #2C1810;  /* Màu chữ tối */
    }

    .prediction-icon {
        font-size: 1.8rem;
        margin-right: 0.5rem;
        color: #2C1810;  /* Màu icon tối */
    }

    /* Thêm animation cho kết quả */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .prediction-result {
        animation: fadeInUp 0.5s ease-out;
    }

    /* Style cho error message */
    .error-feedback {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .form-control.is-invalid,
    .form-select.is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .form-control.is-invalid:focus,
    .form-select.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }

    /* Style cho tiêu đề section (h2) */
    .text-xl.font-semibold {
        color: #212529;
        font-size: 1.55rem;  /* Tăng font size lớn hơn */
        margin-bottom: 1.5rem;  /* Tăng margin bottom */
        font-weight: 600;
        padding-bottom: 0.75rem;  /* Tăng padding bottom */
        border-bottom: 2px solid #f8f9fa;
        letter-spacing: -0.5px;  /* Thêm letter spacing */
    }

    /* Tăng khoảng cách giữa các section */
    .mb-4 {
        margin-bottom: 2.5rem !important;
    }

    /* Style cho form labels */
    .form-label {
        color: #313131;
        font-weight: normal;
        font-size: 1.0rem;
        margin-bottom: 0.5rem;
    }

    /* Style cho input fields */
    .form-control, .form-select {
        border: 1px solid #ced4da;  /* Màu border đậm hơn */
    }

    .form-control:focus, .form-select:focus {
        border-color: #98DDA0;  /* Màu border khi focus khớp với theme */
        box-shadow: 0 0 0 0.2rem rgba(152, 221, 160, 0.25);  /* Shadow nhẹ khi focus */
    }

    /* Style cho range value input */
    .range-value-input {
        width: 60px;
        padding: 2px 5px;
        text-align: center;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .range-value-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(238, 199, 59, 0.25);
        outline: none;
    }

    /* Style cho range input group */
    .range-input-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .range-input-group .form-range {
        flex: 1;
    }

    /* Style cho summary labels */
    .summary-label {
        color: #495057;
        font-weight: normal;
    }

    /* Style cho section container */
    .section-container {
        border: 1px solid #e0dbdb;
        border-radius: 15px;
        padding: 18px;
        background-color: #fff;
        box-shadow: rgba(149, 157, 165, 0.1) 0px 4px 12px;  /* Shadow nhẹ nhàng */
        transition: box-shadow 0.3s ease;  /* Hiệu ứng mượt khi hover */
    }

    /* Hover effect cho section */
    .section-container:hover {
        box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;  /* Shadow đậm hơn khi hover */
    }

    /* Điều chỉnh margin cho tiêu đề trong section */
    .section-container .text-xl.font-semibold {
        margin-bottom: 1.25rem;
    }

    /* Điều chỉnh padding cho row trong section */
    .section-container .row {
        padding: 0 0.5rem;
    }

    /* Style cho tiêu đề form */
    .form-title {
        text-align: center;
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
        color: #212529;
    }

   
    

    /* Thêm style cho invalid input */
    .form-control.is-invalid-custom {
        border-color: #dc3545;
    }
    
    .invalid-feedback-custom {
        display: none;
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .form-control.is-invalid-custom + .invalid-feedback-custom {
        display: block;
    }

    /* Animation cho error message */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .invalid-feedback-custom {
        animation: fadeIn 0.3s ease-in;
    }

    /* Thêm style cho blood pressure input */
    .blood-pressure-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .blood-pressure-group input {
        width: 70px;
        text-align: center;
    }

    .blood-pressure-separator {
        font-size: 1.2rem;
        color: #6c757d;
        margin: 0 2px;
        user-select: none;
    }
 
    </style>
</head>
<body>
    {% include 'includes/header.html' %}

    <div class="container mt-5">
        {% if prediction_result %}
        <div class="alert alert-success mb-4" style="background: white; border: none; padding: 0;">
            <div class="prediction-result mb-4">
                <h3>
                    <i class="bi bi-calendar-heart prediction-icon"></i>
                    Predicted Age: <span class="age-value">{{ prediction_result }} </span> years
                </h3>
                {% if prediction_message %}
                <div class="prediction-message">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>{{ prediction_message }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="input-summary">
                <div class="summary-header" data-bs-toggle="collapse" data-bs-target="#inputSummary" style="cursor: pointer;">
                    <h4 class="font-semibold mb-0">Input Summary</h4>
                    <i class="bi bi-chevron-down ms-2"></i>
                </div>
                <div class="collapse" id="inputSummary">
                    <div class="row">
                        <!-- Personal Information -->
                        <div class="col-md-4">
                            <h5 class="font-semibold mb-2">Personal Information</h5>
                            <p><span class="summary-label">Gender:</span> {{ form_data.gender }}</p>
                            <p><span class="summary-label">Height:</span> {{ form_data.height }} cm</p>
                            <p><span class="summary-label">Weight:</span> {{ form_data.weight }} kg</p>
                        </div>

                        <!-- Health Metrics -->
                        <div class="col-md-4">
                            <h5 class="font-semibold mb-2">Health Metrics</h5>
                            <p><span class="summary-label">Blood Pressure:</span> {{ form_data.bloodPressure }}</p>
                            <p><span class="summary-label">Cholesterol:</span> {{ form_data.cholesterol }} mg/dL</p>
                            <p><span class="summary-label">BMI:</span> {{ form_data.bmi }}</p>
                            <p><span class="summary-label">Blood Glucose:</span> {{ form_data.bloodGlucose }} mg/dL</p>
                            <p><span class="summary-label">Bone Density:</span> {{ form_data.boneDensity }} g/cm²</p>
                            <p><span class="summary-label">Vision:</span> {{ form_data.visionSharpness }}</p>
                            <p><span class="summary-label">Hearing:</span> {{ form_data.hearingAbility }} dB</p>
                        </div>

                        <!-- Lifestyle Factors -->
                        <div class="col-md-4">
                            <h5 class="font-semibold mb-2">Lifestyle Factors</h5>
                            <p><span class="summary-label">Physical Activity:</span> {{ form_data.physicalActivity }}</p>
                            <p><span class="summary-label">Smoking Status:</span> {{ form_data.smokingStatus }}</p>
                            <p><span class="summary-label">Alcohol Consumption:</span> {{ form_data.alcoholConsumption }}</p>
                            <p><span class="summary-label">Diet:</span> {{ form_data.diet }}</p>
                        </div>

                        <!-- Medical History -->
                        <div class="col-md-4">
                            <h5 class="font-semibold mb-2 mt-3">Medical History</h5>
                            <p><span class="summary-label">Chronic Diseases:</span> {{ form_data.chronicDiseases }}</p>
                            <p><span class="summary-label">Medication Use:</span> {{ form_data.medicationUse }}</p>
                            <p><span class="summary-label">Family History:</span> {{ form_data.familyHistory }}</p>
                        </div>

                        <!-- Cognitive and Mental Health -->
                        <div class="col-md-4">
                            <h5 class="font-semibold mb-2 mt-3">Cognitive & Mental Health</h5>
                            <p><span class="summary-label">Cognitive Function:</span> {{ form_data.cognitiveFunction }}</p>
                            <p><span class="summary-label">Mental Health:</span> {{ form_data.mentalHealthStatus }}</p>
                            <p><span class="summary-label">Sleep Pattern:</span> {{ form_data.sleepPatterns }}</p>
                        </div>

                        <!-- Environmental & Socioeconomic -->
                        <div class="col-md-4">
                            <h5 class="font-semibold mb-2 mt-3">Environmental & Social</h5>
                            <p><span class="summary-label">Stress Level:</span> {{ form_data.stressLevels }}</p>
                            <p><span class="summary-label">Pollution Exposure:</span> {{ form_data.pollutionExposure }}</p>
                            <p><span class="summary-label">Sun Exposure:</span> {{ form_data.sunExposure }}</p>
                            <p><span class="summary-label">Education:</span> {{ form_data.educationLevel }}</p>
                            <p><span class="summary-label">Income Level:</span> {{ form_data.incomeLevel }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if error_message %}
        <div class="alert alert-danger text-center mb-4">
            {{ error_message }}
        </div>
        {% endif %}
        <form class="modeling-form space-y-8 max-w-4xl mx-auto p-6 bg-white shadow-lg rounded-lg" 
              action="" 
              method="POST">
            {% csrf_token %}
            <h1 class="form-title">Health Modeling Form</h1>

            <!-- Personal Information -->
            <div class="mb-4 section-container">
                <h2 class="text-xl font-semibold">Personal Information</h2>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Gender</label>
                        <select class="form-select {% if errors.gender %}is-invalid{% endif %}" 
                                name="gender" required>
                            <option value="">Select gender</option>
                            <option value="Male" {% if form_data.gender == "Male" %}selected{% endif %}>Male</option>
                            <option value="Female" {% if form_data.gender == "Female" %}selected{% endif %}>Female</option>
                        </select>
                        {% if errors.gender %}
                        <div class="error-feedback">{{ errors.gender }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Height (cm)</label>
                        <input type="number" 
                               class="form-control" 
                               name="height" 
                               step="0.00000000000001"
                               required 
                               value="{{ form_data.height|default:'' }}">
                        <div class="invalid-feedback-custom"></div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" 
                               class="form-control {% if errors.weight %}is-invalid{% endif %}" 
                               name="weight" 
                                step="0.00000000000001"
                               required
                               value="{{ form_data.weight|default:'' }}">
                        {% if errors.weight %}
                        <div class="error-feedback">{{ errors.weight }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Health Metrics -->
            <div class="mb-4 section-container">
                <h2 class="text-xl font-semibold">Health Metrics</h2>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Blood Pressure (Systolic/Diastolic)</label>
                        <div class="blood-pressure-group">
                            <input type="number" 
                                   class="form-control" 
                                   name="systolic" 
                                   placeholder="Sys"
                                   min="0" 
                                    step="0.00000000000001"
                                   required>
                            <span class="blood-pressure-separator">/</span>
                            <input type="number" 
                                   class="form-control" 
                                   name="diastolic" 
                                   placeholder="Diastolic"
                                    step="0.00000000000001"
                                   min="0" 
                                   required>
                            <input type="hidden" name="bloodPressure" value="120/80">
                            <div class="invalid-feedback-custom"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Cholesterol Level (mg/dL)</label>
                        <input type="number" class="form-control" name="cholesterol"  required                                    
                          step="0.00000000000001"

                               value="{{ form_data.cholesterol|default:'' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">BMI</label>
                        <input type="number" class="form-control" name="bmi" 
                         step="0.00000000000001"

                        required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Blood Glucose Level (mg/dL)</label>
                        <input type="number" class="form-control" name="bloodGlucose"  required 
                         step="0.00000000000001"
                        >
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Bone Density (g/cm²)</label>
                        <input type="number" 
                         step="0.00000000000001"

                               class="form-control" 
                               name="boneDensity" 
                               min="-1"
                               required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Vision Sharpness</label>
                        <input type="number" class="form-control" name="visionSharpness" required                                   
                          step="0.00000000000001"
                        >
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Hearing Ability (dB)</label>
                        <input type="number" class="form-control" name="hearingAbility" required
                         step="0.00000000000001"

                        >
                    </div>
                </div>
            </div>

            <!-- Lifestyle Factors -->
            <div class="mb-4 section-container">
                <h2 class="text-xl font-semibold">Lifestyle Factors</h2>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Physical Activity Level</label>
                        <select class="form-select" name="physicalActivity" required>
                            <option value="">Select level</option>
                            <option value="Moderate" {% if form_data.physicalActivity == "Moderate" %}selected{% endif %}>Moderate</option>
                            <option value="Low" {% if form_data.physicalActivity == "Low" %}selected{% endif %}>Low</option>
                            <option value="High" {% if form_data.physicalActivity == "High" %}selected{% endif %}>High</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Smoking Status</label>
                        <select class="form-select" name="smokingStatus" required>
                            <option value="">Select status</option>
                            <option value="Former" {% if form_data.smokingStatus == "Former" %}selected{% endif %}>Former</option>
                            <option value="Current" {% if form_data.smokingStatus == "Current" %}selected{% endif %}>Current</option>
                            <option value="Never" {% if form_data.smokingStatus == "Never" %}selected{% endif %}>Never</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Alcohol Consumption</label>
                        <select class="form-select" name="alcoholConsumption" required>
                            <option value="">Select consumption</option>
                            <option value="Occasional" {% if form_data.alcoholConsumption == "Occasional" %}selected{% endif %}>Occasional</option>
                            <option value="Frequent" {% if form_data.alcoholConsumption == "Frequent" %}selected{% endif %}>Frequent</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Diet</label>
                        <select class="form-select" name="diet" required>
                            <option value="">Select diet</option>
                            <option value="Low-carb" {% if form_data.diet == "Low-carb" %}selected{% endif %}>Low-carb</option>
                            <option value="Balanced" {% if form_data.diet == "Balanced" %}selected{% endif %}>Balanced</option>
                            <option value="Vegetarian" {% if form_data.diet == "Vegetarian" %}selected{% endif %}>Vegetarian</option>
                            <option value="High-fat" {% if form_data.diet == "High-fat" %}selected{% endif %}>High-fat</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Medical History -->
            <div class="mb-4 section-container">
                <h2 class="text-xl font-semibold">Medical History</h2>
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">Chronic Diseases</label>
                        <select class="form-select" name="chronicDiseases" required>
                            <option value="">Select disease</option>
                            <option value="Hypertension" {% if form_data.chronicDiseases == "Hypertension" %}selected{% endif %}>Hypertension</option>
                            <option value="Diabetes" {% if form_data.chronicDiseases == "Diabetes" %}selected{% endif %}>Diabetes</option>
                            <option value="Heart Disease" {% if form_data.chronicDiseases == "Heart Disease" %}selected{% endif %}>Heart Disease</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Medication Use</label>
                        <select class="form-select" name="medicationUse" required>
                            <option value="">Select medication use</option>
                            <option value="Regular" {% if form_data.medicationUse == "Regular" %}selected{% endif %}>Regular</option>
                            <option value="Occasional" {% if form_data.medicationUse == "Occasional" %}selected{% endif %}>Occasional</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Family History</label>
                        <select class="form-select" name="familyHistory" required>
                            <option value="">Select family history</option>
                            <option value="Hypertension" {% if form_data.familyHistory == "Hypertension" %}selected{% endif %}>Hypertension</option>
                            <option value="Diabetes" {% if form_data.familyHistory == "Diabetes" %}selected{% endif %}>Diabetes</option>
                            <option value="Heart Disease" {% if form_data.familyHistory == "Heart Disease" %}selected{% endif %}>Heart Disease</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Cognitive and Mental Health -->
            <div class="mb-4 section-container">
                <h2 class="text-xl font-semibold">Cognitive and Mental Health</h2>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Cognitive Function (0-100)</label>
                        <div class="range-input-group">
                            <input type="range" class="form-range" name="cognitiveFunction" 
                                   min="0" max="100"
                                   
                                required
                                   value="{{ form_data.cognitiveFunction|default:'50' }}">
                            <input type="number" class="range-value-input" 
                             step="0.00000000000001"

                                   min="0" max="100"
                                   value="{{ form_data.cognitiveFunction|default:'50' }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Mental Health Status</label>
                        <select class="form-select" name="mentalHealthStatus" required>
                            <option value="">Select status</option>
                            <option value="Good" {% if form_data.mentalHealthStatus == "Good" %}selected{% endif %}>Good</option>
                            <option value="Poor" {% if form_data.mentalHealthStatus == "Poor" %}selected{% endif %}>Poor</option>
                            <option value="Fair" {% if form_data.mentalHealthStatus == "Fair" %}selected{% endif %}>Fair</option>
                            <option value="Excellent" {% if form_data.mentalHealthStatus == "Excellent" %}selected{% endif %}>Excellent</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sleep Patterns</label>
                        <select class="form-select" name="sleepPatterns" required>
                            <option value="">Select pattern</option>
                            <option value="Insomnia" {% if form_data.sleepPatterns == "Insomnia" %}selected{% endif %}>Insomnia</option>
                            <option value="Normal" {% if form_data.sleepPatterns == "Normal" %}selected{% endif %}>Normal</option>
                            <option value="Excessive" {% if form_data.sleepPatterns == "Excessive" %}selected{% endif %}>Excessive</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Environmental Factors -->
            <div class="mb-4 section-container">
                <h2 class="text-xl font-semibold">Environmental Factors</h2>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Stress Levels (0-10)</label>
                        <div class="range-input-group">
                            <input type="range" class="form-range" name="stressLevels" 
                                   min="0" max="10"
                                    required
                                   value="{{ form_data.stressLevels|default:'5' }}">
                            <input type="number" class="range-value-input" 
                             step="0.00000000000001"

                                   min="0" max="10"
                                   
                                   value="{{ form_data.stressLevels|default:'5' }}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Pollution Exposure (0-10)</label>
                        <div class="range-input-group">
                            <input type="range" class="form-range" name="pollutionExposure" 
                                   min="0" max="10" 
                                    required
                                   value="{{ form_data.pollutionExposure|default:'5' }}">
                            <input type="number" class="range-value-input" 
                             step="0.00000000000001"

                                   min="0" max="10"
                                   
                                   value="{{ form_data.pollutionExposure|default:'5' }}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Sun Exposure (0-12)</label>
                        <div class="range-input-group">
                            <input type="range" class="form-range" name="sunExposure" 
                                   min="0" max="12"
                                    required
                                   value="{{ form_data.sunExposure|default:'6' }}">
                            <input type="number" class="range-value-input" 
                             step="0.00000000000001"

                                   min="0" max="12"
                                   
                                   value="{{ form_data.sunExposure|default:'6' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Socioeconomic Factors -->
            <div class="mb-4 section-container">
                <h2 class="text-xl font-semibold">Socioeconomic Factors</h2>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Education Level</label>
                        <select class="form-select" name="educationLevel" required>
                            <option value="">Select level</option>
                            <option value="Undergraduate" {% if form_data.educationLevel == "Undergraduate" %}selected{% endif %}>Undergraduate</option>
                            <option value="High School" {% if form_data.educationLevel == "High School" %}selected{% endif %}>High School</option>
                            <option value="Postgraduate" {% if form_data.educationLevel == "Postgraduate" %}selected{% endif %}>Postgraduate</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Income Level</label>
                        <select class="form-select" name="incomeLevel" required>
                            <option value="">Select level</option>
                            <option value="Medium" {% if form_data.incomeLevel == "Medium" %}selected{% endif %}>Medium</option>
                            <option value="Low" {% if form_data.incomeLevel == "Low" %}selected{% endif %}>Low</option>
                            <option value="High" {% if form_data.incomeLevel == "High" %}selected{% endif %}>High</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg px-5" id="predictBtn">
                    <span class="normal-text text-white">Predict</span>
                    <span class="loading-text d-none">
                        Predicting
                        <span class="loading-dots ms-2">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </span>
                    </span>
                </button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% load static %}
    <script src="{% static 'js/common.js' %}"></script>
    <script>
    $(document).ready(function() {
        // Initialize Selectize for dropdown fields
        $('select').selectize({
            sortField: 'text'
        });
    });

    // Handle summary header toggle
    document.querySelector('.summary-header').addEventListener('click', function() {
        const icon = this.querySelector('i');
        if (icon.classList.contains('bi-chevron-up')) {
            icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
        } else {
            icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
        }
    });

    // Handle range input groups
    document.querySelectorAll('.range-input-group').forEach(function(group) {
        const rangeInput = group.querySelector('.form-range');
        const valueInput = group.querySelector('.range-value-input');

        // Đồng bộ giá trị ban đầu
        valueInput.value = rangeInput.value;

        // Cập nhật input khi kéo slider
        rangeInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            valueInput.value = value; // Không làm tròn, giữ nguyên giá trị thập phân
        });

        // Cập nhật slider khi nhập số
        valueInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            const min = parseFloat(rangeInput.min);
            const max = parseFloat(rangeInput.max);

            if (!isNaN(value)) {
                // Giới hạn trong khoảng min-max
                const limitedValue = Math.min(Math.max(value, min), max);
                rangeInput.value = limitedValue;
                this.value = limitedValue; // Giữ nguyên giá trị thập phân
            }
        });

        // Xử lý khi blur khỏi input
        valueInput.addEventListener('blur', function() {
            const value = parseFloat(this.value);
            const min = parseFloat(rangeInput.min);
            const max = parseFloat(rangeInput.max);

            if (isNaN(value)) {
                this.value = min;
                rangeInput.value = min;
            } else if (value < min) {
                this.value = min;
                rangeInput.value = min;
            } else if (value > max) {
                this.value = max;
                rangeInput.value = max;
            }
        });
    });

    // Gộp tất cả xử lý form submit vào một đoạn code
    document.addEventListener('DOMContentLoaded', function() {
        // Xử lý form submit
        document.querySelector('form').addEventListener('submit', function(e) {
            let isValid = true;
            const button = document.getElementById('predictBtn');
            const normalText = button.querySelector('.normal-text');
            const loadingText = button.querySelector('.loading-text');
            
            // 1. Validate tất cả input number
            this.querySelectorAll('input[type="number"]:not(.range-value-input)').forEach(function(input) {
                if (!validateNumberInput(input)) {
                    isValid = false;
                }
            });

            // 2. Validate blood pressure
            const systolicInput = document.querySelector('input[name="systolic"]');
            const diastolicInput = document.querySelector('input[name="diastolic"]');
            const isValidSystolic = validateBP(systolicInput, true);
            const isValidDiastolic = validateBP(diastolicInput, false);
            
            if (!isValidSystolic || !isValidDiastolic) {
                isValid = false;
            }

            // 3. Nếu có lỗi validation
            if (!isValid) {
                e.preventDefault();
                // Scroll đến input lỗi đầu tiên
                const firstInvalidInput = document.querySelector('.is-invalid-custom');
                if (firstInvalidInput) {
                    firstInvalidInput.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }
                return;
            }

            // 4. Đảm bảo cập nhật giá trị blood pressure trước khi submit
            updateBloodPressure();

            // 5. Nếu form hợp lệ, hiển thị loading state
            button.disabled = true;
            normalText.classList.add('d-none');
            loadingText.classList.remove('d-none');
            
            // 6. Nếu có lỗi thì enable lại button sau 3s
            setTimeout(() => {
                if (document.querySelector('.alert-danger')) {
                    button.disabled = false;
                    normalText.classList.remove('d-none');
                    loadingText.classList.add('d-none');
                }
            }, 3000);
        });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.range-input-group').forEach(function(group) {
            const rangeInput = group.querySelector('.form-range');
            const valueInput = group.querySelector('.range-value-input');

            // Đồng bộ giá trị ban đầu
            valueInput.value = rangeInput.value;

            // Cập nhật input khi kéo slider
            rangeInput.addEventListener('input', function() {
                const value = parseFloat(this.value);
                valueInput.value = value; // Không làm tròn, giữ nguyên giá trị thập phân
            });

            // Cập nhật slider khi nhập số
            valueInput.addEventListener('input', function() {
                const value = parseFloat(this.value);
                const min = parseFloat(rangeInput.min);
                const max = parseFloat(rangeInput.max);

                if (!isNaN(value)) {
                    // Giới hạn trong khoảng min-max
                    const limitedValue = Math.min(Math.max(value, min), max);
                    rangeInput.value = limitedValue;
                    this.value = limitedValue; // Giữ nguyên giá trị thập phân
                }
            });

            // Xử lý khi blur khỏi input
            valueInput.addEventListener('blur', function() {
                const value = parseFloat(this.value);
                const name = this.name;
                
                // Chỉ set giá trị mặc định khi input trống hoặc không phải là số
                if (this.value === '' || isNaN(value)) {
                    if (name === 'boneDensity') {
                        this.value = -1;
                    } else {
                        this.value = 1; // hoặc giá trị mặc định phù hợp khác
                    }
                    validateNumberInput(this);
                }
            });
        });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Validate tất cả input number (trừ slider và range-value-input)
        document.querySelectorAll('input[type="number"]:not(.range-value-input)').forEach(function(input) {
            // Thêm div feedback nếu chưa có
            if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('invalid-feedback-custom')) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'invalid-feedback-custom';
                input.parentNode.insertBefore(feedbackDiv, input.nextSibling);
            }

            // Validate khi nhập
            input.addEventListener('input', function() {
                validateNumberInput(this);
            });

            // Validate khi blur
            input.addEventListener('blur', function() {
                const value = parseFloat(this.value);
                const name = this.name;
                
                // Chỉ set giá trị mặc định khi input trống hoặc không phải là số
                if (this.value === '' || isNaN(value)) {
                    if (name === 'boneDensity') {
                        this.value = -1;
                    } else {
                        this.value = 1; // hoặc giá trị mặc định phù hợp khác
                    }
                    validateNumberInput(this);
                }
            });
        });

        function validateNumberInput(input) {
            const value = parseFloat(input.value);
            const name = input.name;
            const feedbackDiv = input.nextElementSibling;
            let isValid = true;
            let errorMessage = '';

            if (isNaN(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid number';
            } else if (name === 'boneDensity') {
                if (value < -1) {
                    isValid = false;
                    errorMessage = 'Bone Density must be greater than or equal to -1';
                }
            } else {
                if (value <= 0) {
                    isValid = false;
                    switch(name) {
                        case 'height':
                            errorMessage = 'Height must be greater than 0 cm';
                            break;
                        case 'weight':
                            errorMessage = 'Weight must be greater than 0 kg';
                            break;
                        case 'cholesterol':
                            errorMessage = 'Cholesterol must be greater than 0 mg/dL';
                            break;
                        case 'bmi':
                            errorMessage = 'BMI must be greater than 0';
                            break;
                        case 'bloodGlucose':
                            errorMessage = 'Blood Glucose must be greater than 0 mg/dL';
                            break;
                        case 'visionSharpness':
                            errorMessage = 'Vision Sharpness must be greater than 0';
                            break;
                        case 'hearingAbility':
                            errorMessage = 'Hearing Ability must be greater than 0 dB';
                            break;
                        default:
                            errorMessage = 'Value must be greater than 0';
                    }
                }
            }

            // Hiển thị/ẩn thông báo lỗi
            if (!isValid) {
                input.classList.add('is-invalid-custom');
                if (feedbackDiv) {
                    feedbackDiv.textContent = errorMessage;
                    feedbackDiv.style.display = 'block';
                }
            } else {
                input.classList.remove('is-invalid-custom');
                if (feedbackDiv) {
                    feedbackDiv.style.display = 'none';
                }
            }

            return isValid;
        }

        // Validate form trước khi submit
        // document.querySelector('form').addEventListener('submit', function(e) {
        //     let isValid = true;
            
        //     // Validate tất cả input number
        //     this.querySelectorAll('input[type="number"]:not(.range-value-input)').forEach(function(input) {
        //         if (!validateNumberInput(input)) {
        //             isValid = false;
        //         }
        //     });

        //     if (!isValid) {
        //         e.preventDefault(); // Ngăn form submit nếu có lỗi
        //         // Scroll đến input lỗi đầu tiên
        //         const firstInvalidInput = document.querySelector('.is-invalid-custom');
        //         if (firstInvalidInput) {
        //             firstInvalidInput.scrollIntoView({ 
        //                 behavior: 'smooth', 
        //                 block: 'center' 
        //             });
        //         }
        //     }
        // });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const systolicInput = document.querySelector('input[name="systolic"]');
        const diastolicInput = document.querySelector('input[name="diastolic"]');
        const hiddenBPInput = document.querySelector('input[name="bloodPressure"]');
        
        // Function để update hidden input
        function updateBloodPressure() {
            const systolic = systolicInput.value || '120';
            const diastolic = diastolicInput.value || '80';
            hiddenBPInput.value = `${systolic}/${diastolic}`;
        }

        // Gọi updateBloodPressure ngay khi trang load
        updateBloodPressure();

        // Event listeners
        systolicInput.addEventListener('input', function() {
            validateBP(this, true);
            updateBloodPressure();
        });

        diastolicInput.addEventListener('input', function() {
            validateBP(this, false);
            updateBloodPressure();
        });

        // Validate khi blur
        systolicInput.addEventListener('blur', function() {
            if (this.value === '') this.value = '120';
            validateBP(this, true);
            updateBloodPressure();
        });

        diastolicInput.addEventListener('blur', function() {
            if (this.value === '') this.value = '80';
            validateBP(this, false);
            updateBloodPressure();
        });

        // Validate và update khi nhập
        function validateBP(input, isSystemic) {
            const value = parseInt(input.value);
            const min = 0;
            const feedbackDiv = input.parentElement.querySelector('.invalid-feedback-custom');

            if (isNaN(value) || value < min) {
                input.classList.add('is-invalid-custom');
                feedbackDiv.textContent = `${isSystemic ? 'Systolic' : 'Diastolic'} must be greater than ${min}`;
                feedbackDiv.style.display = 'block';
                return false;
            } else {
                input.classList.remove('is-invalid-custom');
                feedbackDiv.style.display = 'none';
                return true;
            }
        }

        // Thêm validation cho form submit
        // document.querySelector('form').addEventListener('submit', function(e) {
        //     const isValidSystolic = validateBP(systolicInput, true);
        //     const isValidDiastolic = validateBP(diastolicInput, false);
            
        //     if (!isValidSystolic || !isValidDiastolic) {
        //         e.preventDefault();
        //         systolicInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        //     }
        //     // Đảm bảo cập nhật giá trị hidden input trước khi submit
        //     updateBloodPressure();
        // });
    });
    </script>
           {% include 'includes/footer.html' %}

</body>
</html>